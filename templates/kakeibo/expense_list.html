{% extends 'base.html' %}
{% load humanize %}
{% block title %}家計簿 — 一覧{% endblock %}

{# ==== 右上の操作ボタン ==== #}
{% block page_actions %}
<div class="btn-group">
  <a class="btn btn-primary" href="{% url 'kakeibo:expense_add' %}">+支出</a>
  <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split"
          data-bs-toggle="dropdown" aria-expanded="false">
    <span class="visually-hidden">切替</span>
  </button>
  <ul class="dropdown-menu dropdown-menu-end">
    <li><a class="dropdown-item" href="{% url 'kakeibo:expense_add' %}">手入力で追加</a></li>
    <li><a class="dropdown-item" href="{% url 'kakeibo:receipt_upload' %}">レシートから追加（OCR）</a></li>
  </ul>
  <a class="btn btn-outline-primary btn-sm" href="{% url 'kakeibo:income_add' %}">＋収入を追加</a>
  <a class="btn btn-outline-secondary btn-sm" href="{% url 'kakeibo:income_list' %}">収入一覧</a>
  <a class="btn btn-outline-secondary btn-sm"
     href="{% url 'kakeibo:budget_list' %}?month={{ current_month|date:'Y-m' }}">予算</a>
</div>
{% endblock %}

{% block content %}

<h1 class="h3 mb-3">家計簿</h1>

{# ===== フィルタ ===== #}
<form method="get" class="row g-2 align-items-end mb-2">
  {# 現在月を維持したいとき用（全件表示にチェックが無ければ効く）#}
  <input type="hidden" name="month" value="{{ current_month|date:'Y-m' }}">

  <div class="col-md-3">
    {{ filter_form.start_date.label_tag }} {{ filter_form.start_date }}
  </div>

  <div class="col-md-3">
    {{ filter_form.end_date.label_tag }} {{ filter_form.end_date }}
  </div>

  <div class="col-md-3">
    {{ filter_form.q.label_tag }} {{ filter_form.q }}
  </div>

  {# ★ 追加：費目ドロップダウン #}
  <div class="col-md-3">
    {{ filter_form.category.label_tag }} {{ filter_form.category }}
  </div>

  {# ★ 追加：月フィルタを無視して全件表示するトグル #}
  <div class="col-md-6">
    <div class="form-check mt-2">
      <input class="form-check-input" type="checkbox"
             id="viewAll" name="view" value="all"
             {% if request.GET.view == 'all' %}checked{% endif %}>
      <label class="form-check-label" for="viewAll">
        すべて表示（当月フィルタを無視）
      </label>
    </div>
  </div>

  <div class="col-md-6 text-end">
    <button class="btn btn-primary" type="submit">絞り込む</button>
    <a class="btn btn-outline-secondary"
       href="{% url 'kakeibo:expense_list' %}?month={{ current_month|date:'Y-m' }}">リセット</a>
  </div>
</form>

{# ===== 月送り & 表示切替（今月 / すべて） ===== #}
<div class="d-flex align-items-center gap-2 mb-2">
  <div class="btn-group">
    <a class="btn btn-outline-secondary"
       href="?{% if base_qs %}{{ base_qs }}&{% endif %}month={{ prev_month|date:'Y-m' }}">« 前月</a>
    <span class="btn btn-light disabled">{{ current_month|date:"Y年n月" }}</span>
    <a class="btn btn-outline-secondary"
       href="?{% if base_qs %}{{ base_qs }}&{% endif %}month={{ next_month|date:'Y-m' }}">翌月 »</a>
  </div>

  <a class="btn btn-outline-primary ms-2"
     href="?{% if base_qs %}{{ base_qs }}&{% endif %}month={{ this_month|date:'Y-m' }}">今月</a>

  <div class="ms-auto">
    {% if view_all %}
      <a class="btn btn-sm btn-outline-secondary"
         href="?{% if base_qs %}{{ base_qs }}&{% endif %}month={{ current_month|date:'Y-m' }}">今月だけ表示</a>
    {% else %}
      <a class="btn btn-sm btn-outline-secondary"
         href="?{% if base_qs %}{{ base_qs }}&{% endif %}month={{ current_month|date:'Y-m' }}&view=all">すべて見る</a>
    {% endif %}
  </div>
</div>

{# ===== 今月の収支サマリ ===== #}
<div class="alert alert-light border small mb-3">
  今月の支出：<strong>{{ this_month_expense|default:0|intcomma }}円</strong>　
  収入：<strong>{{ this_month_income|default:0|intcomma }}円</strong>　
  収支：
  <strong class="{% if this_month_net < 0 %}text-danger{% else %}text-success{% endif %}">
    {{ this_month_net|default:0|intcomma }}円
  </strong>
</div>

{# ===== 一覧（まとめ削除フォーム） ===== #}
<form method="post" action="{% url 'kakeibo:expense_bulk_delete' %}">
  {% csrf_token %}

  <div class="d-flex justify-content-between align-items-center mb-2">
    <label class="form-check mb-0">
      <input type="checkbox" class="form-check-input" id="checkAllHead">
      <span class="form-check-label">全選択 / 解除</span>
    </label>
    <button type="submit" class="btn btn-sm btn-danger" id="bulkDeleteBtn" disabled>
      選択を削除
    </button>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <colgroup>
        <col style="width: 40px;">   {# チェック #}
        <col style="width: 140px;">  {# 日付 #}
        <col>                         {# 項目 #}
        <col style="width: 140px;">  {# 金額 #}
        <col style="width: 160px;">  {# 費目 #}
        <col style="width: 140px;">  {# 操作 #}
      </colgroup>
      <thead>
        <tr>
          <th><input type="checkbox" id="checkAllHead2"></th>
          <th>日付</th>
          <th>項目</th>
          <th class="text-end">金額</th>
          <th>費目</th>
          <th class="text-center">操作</th>
        </tr>
      </thead>
      <tbody>
        {% for e in expenses %}
          <tr>
            <td>
              <input class="form-check-input selectRow" type="checkbox" name="selected" value="{{ e.id }}">
            </td>
            <td>{{ e.date|date:"Y-m-d" }}</td>
            <td>{{ e.item }}</td>
            <td class="text-end">{{ e.amount|default:"-"|intcomma }}円</td>
            <td>{{ e.category.name|default:"-" }}</td>
            <td class="text-center" style="white-space: nowrap;">
              <a class="btn btn-sm btn-primary me-1" href="{% url 'kakeibo:expense_edit' e.pk %}">編集</a>
              <a class="btn btn-sm btn-outline-danger" href="{% url 'kakeibo:expense_delete' e.pk %}">削除</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="text-muted">まだデータがありません</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</form>

{% endblock %}

{# ===== ページネーション（view=all でもクエリ維持） ===== #}
{% if is_paginated %}
<nav aria-label="pager" class="mt-3">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?{% if base_qs %}{{ base_qs }}&{% endif %}{% if current_month %}month={{ current_month|date:'Y-m' }}&{% endif %}{% if view_all %}view=all&{% endif %}page={{ page_obj.previous_page_number }}">前へ</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">前へ</span></li>
    {% endif %}
    {% for p in paginator.page_range %}
      {% if p == page_obj.number %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
      {% else %}
        <li class="page-item">
          <a class="page-link"
             href="?{% if base_qs %}{{ base_qs }}&{% endif %}{% if current_month %}month={{ current_month|date:'Y-m' }}&{% endif %}{% if view_all %}view=all&{% endif %}page={{ p }}">{{ p }}</a>
        </li>
      {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?{% if base_qs %}{{ base_qs }}&{% endif %}{% if current_month %}month={{ current_month|date:'Y-m' }}&{% endif %}{% if view_all %}view=all&{% endif %}page={{ page_obj.next_page_number }}">次へ</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">次へ</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% block extra_js %}
<script>
  // まとめ削除：全選択＆ボタン活性制御
  (function(){
    const master1 = document.getElementById('checkAllHead');
    const master2 = document.getElementById('checkAllHead2');
    const masters = [master1, master2].filter(Boolean);
    const boxes = Array.from(document.querySelectorAll('.selectRow'));
    const btn = document.getElementById('bulkDeleteBtn');

    function refresh() {
      const any = boxes.some(b => b.checked);
      if (btn) btn.disabled = !any;
      // ヘッダのチェック状態（全て選ばれていればON）
      const allOn = boxes.length && boxes.every(b => b.checked);
      masters.forEach(m => { if (m) m.checked = allOn; });
    }
    masters.forEach(m => m && m.addEventListener('change', e => {
      const on = e.target.checked;
      boxes.forEach(b => b.checked = on);
      refresh();
    }));
    boxes.forEach(b => b.addEventListener('change', refresh));
    refresh();
  })();
</script>
{% endblock %}